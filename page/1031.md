# 使用“4+1”模型描述软件体系结构

　　对于同一座建筑，住户、建筑师、内部装修人员和电气工程师有各自的视角。这些视角反映了建筑物的不同方面，但它们彼此都有内在的联系，而且合起来形成了建筑物的总体结构。

　　软件体系结构反映了软件系统的总的结构，它和建筑物一样，存在不同的角度来反映系统的体系结构。

　　当面对一个复杂的系统时，必须从多个角度来考虑问题。在处理体系结构时我们通常只考虑系统功能方面的需求，而实际上除了功能，物理分布、过程通信和同步等也必须在体系结构一级加以考虑。这些来自不同方面的需求就形成了软件体系结构的不同视角。每种不同的视角说明了系统中不同角色或参与者(Stakeholder)各自所关注的焦点。每个视角都可以看成是一幅软件蓝图，同时具有自己的标记方法，可以选择自己的体系结构风格。

　　当然，所有视角并不是完全独立的，不同视角之间的元素在一定的规则下是相关联的。

​         从1990年开始，Rational公司的Philippe Kruchten对软件体系结构的不同视角进行了专门的研究，并于1995年在IEEE提出了用于体系结构描述的“4+1”视图模型(The 4+1 View Model of Architecture)。

​          它们是逻辑视图(Logical View)、过程视图(Process View)、物理视图(Physical View)、开发视图(Development View)，另外加上场景(Scenarios)。“4+1”视图模型为理解复杂系统的软件体系结构提供了一个简单和易于理解的方式。它从 5个不同的角度来描述软件，每个角度都显示了模型系统的一个具体方面。

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191222190730.png)

<center>“4+1”模型由5个视图组成</center>

```
　　其中：
  ● 逻辑视图：当采用面向对象的设计方法时，逻辑视图即是对象模型。 
  ● 过程视图：描述系统的并发和同步方面的设计。 
  ● 物理视图：描述软件到硬件之间的映射关系，反映系统在分布方面的设计。 
  ● 开发视图：描述软件在开发环境下的静态组织结构。 
  对体系结构进行的描述是围绕着以上4个视图展开的。然后，通过选择出的一些用例对体系结构加以说明。这些用例被称做场景，它们构成了第5个视图。实际上，体系结构在某种程度上是由场景演化而来的。
```

​        体系结构的概念在每个视图里面都可以独立应用。这就是说，可以在每个视图里面定义体系结构的各种组成元素，如构件、连接件等。对于不同的视图，还可以选择不同的体系结构风格，因此在同一个系统结构中可以使用多种风格。此外，在每一种视图里，我们使用该视图特定的符号。这避免了符号用法和意义的混乱。“4+1”视图模型是一个十分通用的模型：可以使用其他的符号表示法，也可以使用其他的设计方法，尤其是逻辑视图和过程视图的分解。

　　“4+1”模型实际上使得有不同需求的人员能够得到他们对于软件体系结构想要了解的东西。系统工程师先从物理视图，然后从过程视图靠近体系结构；最终使用者、客户、数据专家从逻辑视图看体系结构；项目经理、软件配置人员从开发视图看体系结构。

　　要指出的是，不是所有的软件体系结构都需要完整的“4+1”视图。没有用的视图在体系结构描述中可以被省略，例如对于非常小的系统，逻辑视图和开发视图有可能非常相似，以至于没有必要把它们分开描述。场景视图在各种环境下都是有用的。

```
下面将分别讨论这5种视图，考察每种视图所涉及的方面，所使用的符号表示，以及在描述和管理该视图时要用到的工具。下文中，将以简化了的专用自动交换分机系统和航空交通管制系统为例进行讨论。
```



## 逻辑视图(Logical View)

- ### 概述

- 逻辑视图的体系结构：面向对象的分解

- 当采用面向对象的设计方法时，逻辑视图即是对象模型。 

- 逻辑视图主要支持功能需求——系统**应当向用户提供什么样的服务**。

  - 从问题域出发，采用面向对象的方法，按照抽象、封装、继承的原则进行分解，得到代表着系统的关键抽象表示的集合。这些抽象表示的具体形式就是对象和对象的类。这种分级不仅是为了功能分析，而且还担负着在系统的各部分中确定公共机制和设计元素的作用。
  - 使用Rational/Booch方法，通过类图(Class Diagram)和类模板(Class Template)来表示逻辑体系结构。类图显示了类的集合和它们的逻辑关系：关联(Association)、组合(Composition)、使用(Usage)、继承(Inheritance)等。类模板则着眼于每个类的个体，强调类的主要操作，并确定对象的关键特征。当十分需要定义一个对象的内部行为时，要使用状态转换图(State Transition Diagram)，或者是状态表(State Chart)。相关类的集合可以归到一起，称作类的种属(Class Category)。
  - 除了面向对象的方法，还可以使用其他形式的逻辑体系结构。例如，当所面对的应用具有很明显的数据驱动的特征时，可以使用E-R图。

- ### 逻辑视图的符号表示法

  - 逻辑体系结构的符号表示法是从Booch方法派生而来的。



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221203559.png)

<center>逻辑视图的符号表示法</center>

  - 它被极大地简化了，尤其大量简化了在这个设计阶段作用不大的各种修饰，只考虑对于体系结构有重要意义的元素。

  - 在设计工具上，可以使用Rational Rose等UML建模工具。公共的机制和服务在类设施(Class Utilities)中定义。

- ### 逻辑视图的风格

  - 逻辑视图也可以采用面向对象的风格。
  - 逻辑视图设计的主要准则是，要设法在整个系统中保持一个单一的、连贯的对象模型，避免类和相关机制按照场地或处理器过早地分化。

- ### 例子

  - 图4-19(a)显示了一个专用自动交换分机的例子。
  - ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221203853.png)
  - 图4-19  逻辑视图举例(a) 专用自动交换分机的逻辑设计图；  (b) 航空交通管制系统的逻辑设计图
  - ​          专用自动交换分机用于在通信终端之间建立连接。通信终端可能是电话机、中继线(连接到中心室的线路)、专用线(专用自动交换分机和一般的交换分机之间的线路)、数据线、ISDN线等。不同的线路需要不同的线路接口卡的支持。线路控制器对象负责从线路接口卡接收信号，以及向它发送信号，并完成信号和一系列的事件(如开始、结束、计数等)之间的转换。控制器还必须受到严格的实时要求的约束。 
  - 　　为了适应不同的接口，这个类有许多子类。终端对象负责维护终端的状态，并代表所在的线路提供通信服务。会话对象代表在一个对话中涉及的终端的集合。会话对象使用转换服务(逻辑地址和物理地址之间的映射、路由等)和连接服务建立两个终端之间的语音连接。
  - 　　和前一个系统相比，航空交通管制系统是一个规模大得多的系统。图4-19(b)中显示的是一个包括8个类种属(即类的分组)的航空交通管制系统的最顶层的类图。

## 过程视图(Process View)

+ ### 概述
  + 过程视图的体系结构：过程分解
  + 描述系统的并发和同步方面的设计。
  + 过程体系结构考虑的是一些非功能性的需求，诸如性能、可用性等。
  + 它所要面对的问题有并发、分布、系统的完整性、容错能力等。
  + 它还要考虑怎样把过程体系结构与逻辑视图体系结构的要点相适应——**对某个对象的某个操作实际上是在哪个控制线程上发生的。**
  + 　　可以把过程体系结构分为几个抽象层次来描述，每个层次考虑不同的方面。在最高层次上，过程体系结构可以被视为一个逻辑网络的集合。每个独立执行的逻辑网络都是由通信程序(即“过程”)构成的。这些逻辑网络分布在一个通过LAN或WAN连接起来的硬件资源集合上。多个逻辑网络可能同时存在，并共享同样的物理资源。例如，逻辑网络的概念可用于区分在线处理系统和离线处理系统。
  + 　　这里所说的过程，是指构成一个可执行单元的一组任务。过程代表了在何种层次上过程体系结构可以进行策略控制，如启动、恢复、重新配置和关闭。
  + 　　软件被分为独立的任务的集合。每个任务是一个独立的控制线程，可以在一个处理节点上独立单独调度。因此可以将任务分为主任务和辅任务。主任务是需要单独解决的体系结构元素。辅任务是由于实现原因而在本地加入的附加任务(缓冲、超时等)，例如可以将它们实现为轻量级的线程。 
  + 　　主任务通过一套完善定义的任务间通信机制进行通信：同步的或异步的基于消息的通信服务、远程过程调用、时间广播等。不应当假设通信中的主任务处于同一个过程中或处在同一个处理节点上。辅任务的通信可以采用共享内存的方式或其他双方约定的方式。
  + 　　基于过程的体系结构设计图可以估计出消息流和过程负荷。

+ ### 过程视图的符号表示法

  - 这里介绍的过程体系结构符号表示法是从Booch为Ada任务分配提出的符号表示法扩展而来的。

  - 与逻辑视图的符号表示法类似，它也被极大地简化了，只考虑对于体系结构有重要意义的元素，如图过程视图的符号表示法

  - - ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221204148.png)
    - 在辅助工具的选择上，可以考虑使用TRW提供的UNAS(Universal Network Achitecture Services)产品。它可用于把各种过程和任务构建并实现为过程的逻辑网络。UNAS里面包含的一个工具SALE(Software Architecture Lifecycle Environment)支持这样的符号表示法。SALE允许过程体系结构的图形化描述，包括对可能的任务间通信路径的规格说明。然后，从这种规格说明可以自动生成相应的Ada或C++语言源代码。

+ ### 过程视图的风格

  - 有多种风格适合过程体系结构。例如管道-过滤器、客户/服务器及其变体(多客户/单服务器、多客户/多服务器等)

+ ### 例子

  - 在下图所示的例子中，所有的终端是由单一的一个终端过程处理的。这个终端过程由输入队列中的消息驱动。控制过程由3个任务组成，控制对象在其中之一上执行。低速循环任务扫描所有的非激活终端(200 ms)，它将所有变为激活的终端放入高速循环扫描 (10 ms)的扫描列表中；高速循环扫描探测扫描列表里终端的重要的状态改变，并将这种改变传输给主控任务；主控任务解读这种状态改变并通过消息与相关终端通信。这里，控制过程内部的消息通信是通过共享内存的方式实现的。

    ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221204355.png)

    <center>专用自动交换分机的过程设计图</center>

## 开发视图(Development View)

+ ### 概述

  + 开发视图的体系结构：子系统分解
  + 描述软件在开发环境下的静态组织结构。
  + 开发视图关注的是在软件开发环境中软件模块的实际组织。软件被打包成可以由单个或少量程序员开发的各种小的部分：程序库或子系统。子系统被组织成层次化的体系，每层为上一层提供一个严密的、明确定义的接口。　　
  + 系统的开发体系结构用模块图和子系统图来表示，在图中可以显示出“导入”和“导出”关系。完整的开发体系结构只有在软件系统的所有元素被识别出来之后才能被描述。控制开发体系结构的原则是：分割、编组、可视。
  + 开发体系结构主要考虑的是内部需求，这些需求的目的是要使开发相关的活动更易于进行，如软件管理、软件复用、开发工具集所造成的约束、编程语言等。开发体系结构是许多开发活动的基础，包括需求配置、团队组织和工作分配、成本估算和成本规划、项目进度监控、软件可重用性和可移植性分析、软件安全分析等。它是建立软件产品线的基础。

+ ### 开发视图的符号表示法

  - 与前面类似，开发视图的符号表示法采用Booch表示法的变体，并且只考虑对于体系结构有重要意义的元素![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221204648.png)

    <center>开发视图的符号表示法</center>

  - Rational公司的Apex Development Environment 支持对开发视图的定义和实现，也支持上面描述的分层策略和对设计规则的执行。在Rational Rose中，可以绘制模块层和子系统层的开发体系结构图，还可以在逆向工程中从已经开发的源代码(Ada或C++)中得出系统的开发体系结构图。

+ ### 开发视图的风格

  - 对于开发视图，我们建议采用分层风格，定义4～6层的子系统。
  - 每一层都有明确定义的责任。
  - 设计规则是，某一层的子系统只能依赖于本层或其下层的子系统。
  - 这样做的目的是使模块间相互依赖而构成的复杂网络最小化，并使得系统可以采用逐层的策略完成释放。

+ ### 例子

  + 下图用5个层次表示了航空交通管制系统产品线的开发组织。此开发体系结构是与图4-19(b)中描述的逻辑体系结构相对应的。

  + ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221204805.png)

    <center>航空交通管制系统的5个层次</center>

  + 第1、2层是在软件产品线中常见的分布式系统基础结构。这两层独立于应用域，并将上层系统遮蔽起来，防止其受到硬件平台、操作系统、数据库等变化的影响。在这两层的基础上，第3层增加了一个航空交通管制(ATC)框架，成为一个用于特定应用领域的软件系统结构。使用这一框架，第4层构造了一系列的功能模块。第5层与用户和产品相关，包括大多数的用户界面与外部系统的接口。在这5层中，共分布着72个子系统，每层大约包括10～50个模块。

## 物理视图(Physical View)

+ ### 概述
  + 描述软件到硬件之间的映射关系，反映系统在分布方面的设计。
  + 物理视图的体系结构：从软件到硬件的映射
    + 物理体系结构主要考虑的是非功能性的系统需求，如系统的可用性、可靠性(容错性)、性能(信息吞吐量)和可扩展性。
    + 软件系统在计算机网络的各个处理节点上运行。
    + 各种被确定出的元素——网络、过程、任务和对象——需要映射到各种节点上去，将用到不同的物理配置，有些用于开发和测试，有些用于不同场所或不同用户。
    + 因此从软件到处理节点的映射需要高度灵活，并且最小限度地影响其本身的源代码。

+ ### 物理视图的符号表示法

  - 下图所示为物理视图的符号表示法。

    ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221205058.png)

    <center>物理视图的符号表示法</center>

  - 大型系统中的物理视图可能非常凌乱

    - TRW公司的UNAS允许使用者采用数据驱动的方式将过程体系结构映射到物理体系结构，并允许在不修改源代码的情况下对这种映射做出多种改动。

+ ### 例子

  + 大型专用自动交换分机的一种可能的硬件配置。

    ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221205219.png)

    <center>专用自动交换分机的物理体系结构</center>

    

## 场景视图(Scenarios)

- 场景视图的体系结构：汇总
  - 通过使用一些重要场景，4个视图中的元素可以协调地共同工作。
  - 尽管这些场景是一个小集合，但是它们很重要。
  - 场景是更通用的概念——用例的实例。
  - 从某种意义上讲，场景是最重要的需求的抽象。
  - 场景的设计使用对象场景图(Object Scenario Diagram)和对象交互图来表示。

- 相对于其他的4个视图，场景视图是多余出来的(所以称为“4+1”)，但是它承担着两个任务
  - 在下面要讲到的体系结构设计中，将以此视图为驱动来发现体系结构元素。
  - 在体系结构设计结束后，此视图承担验证和描述的角色。它不仅用于书面记录，并且是体系结构原型测试的起始点。

- 场景视图的符号表示法
  - 场景视图的符号表示法中，构件的表示与逻辑视图非常相似，但是连接件的表示使用过程视图中的方法。
  - 注意，对象的实例用细实线表示。
  - 在工具的使用方面，和逻辑体系结构类似，可以使用Rational Rose绘制和管理对象场景图。

- 例子

  - 下图显示了用于小型专用自动交换分机的场景的片段。

    ![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191221205404.png)

    <center>场景的雏形——本地呼叫选择阶段</center>

  - 　　(1) 小王的电话控制器检测和验证电话从挂机到摘机状态的转变，并且发送一个消息来唤醒相关的终端对象。

  - 　　(2) 终端分配一定的资源，并通知控制器发出拨号音。

  - 　　(3) 控制器收到所拨号码并将它们发送给终端。

  - 　　(4) 终端使用编号计划分析号码。

  - 　　(5) 当一个有效的拨号序列进入时，终端打开一个会话。

　　



从以上分析可知，逻辑视图和开发视图描述系统的静态结构，而进程视图和物理视图描述系统的动态结构。对于不同的软件系统来说，侧重的角度也有所不同。例如，对于管理信息系统来说，比较侧重于从逻辑视图和开发视图来描述系统，而对于实时控制系统来说，则比较注重于从进程视图和物理视图来描述系统。 





